# Deployment Guide

This guide captures the minimum steps to deploy SirTrav A2A Studio and verify the public scaffold in a Netlify environment. It complements `docs/DEPLOYMENT_READINESS.md` with a concise, end-to-end flow.

## 1) Prerequisites
- Node.js 18+.
- Netlify site linked to this repository.
- Required environment variables configured (see **Environment variables** below).

## 2) Environment variables
Create `.env.example` as a template for local development and mirror required values in Netlify **Site settings → Environment variables** for production.

### Required for production
| Variable | Purpose | Notes |
| --- | --- | --- |
| `URL` | Base site URL used by pipeline scripts and functions. | Example: `https://your-site.netlify.app` |
| `PUBLISH_TOKEN_SECRET` | Auth token for `/.netlify/functions/start-pipeline`. | If unset, only `demo` token is accepted. |

### Optional (feature flags / demo stubs)
| Variable | Purpose | Notes |
| --- | --- | --- |
| `MCP_SECRET_TOKEN` | Enables the MCP function auth gate. | Omit if MCP is unused. |
| `STORAGE_BACKEND` | Storage backend selector. | Only `netlify_lm` is supported in this repo. |
| `ELEVENLABS_API_KEY` | Voice integration (stubbed). | Omit for placeholder outputs. |
| `ELEVENLABS_DEFAULT_VOICE_ID` | Voice preset (stubbed). | Optional in demo mode. |
| `SUNO_API_KEY` | Music generation (stubbed). | Omit for placeholder outputs. |
| `OPENAI_API_KEY` | Writer/Director agent (stubbed). | Optional in demo mode. |
| `GEMINI_API_KEY` | Curate-media vision (stubbed). | Optional in demo mode. |

> Social publishing integrations are not implemented in this repo. The `publish` function only returns a Netlify Large Media URL.

## 3) Build & pre-deploy checks
Run the following commands from the repo root:

```bash
npm ci
npm run preflight
npm run test:runner
npm run practice:test
npm run verify:security
npm run build
```

- `verify:security` requires Netlify Dev running (`npm run dev`) or a deployed `URL`.
- `dist/` is generated by `npm run build` and is not committed to git.

## 4) Deploy to Netlify
- Netlify is configured via `netlify.toml` to run `npm ci && npm run build`.
- Ensure Node 18 is selected in the Netlify build settings.

## 5) Post-deploy verification
After deploy, use the site URL:

```bash
curl -s "$URL/.netlify/functions/healthcheck"
curl -s -X POST "$URL/.netlify/functions/curate-media" -H "Content-Type: application/json" -d '{"projectId":"demo"}'
curl -s -N "$URL/.netlify/functions/progress?projectId=demo" | head -n 5
curl -s -X POST "$URL/.netlify/functions/submit-evaluation" -H "Content-Type: application/json" -d '{"projectId":"demo","rating":"good"}'
```

To validate auth on the pipeline trigger:

```bash
curl -s -X POST "$URL/.netlify/functions/start-pipeline" -H "Content-Type: application/json" -d '{"projectId":"demo"}'
curl -s -X POST "$URL/.netlify/functions/start-pipeline" -H "Authorization: Bearer $PUBLISH_TOKEN_SECRET" -H "Content-Type: application/json" -d '{"projectId":"demo"}'
```

## 6) Rollback plan
- Use Netlify’s deploy list to roll back to the last known good deploy.
- Re-run the **post-deploy verification** checks above after rollback.

## 7) Known limitations
- `pipelines/scripts/ffmpeg_compile.mjs` is a stub that writes placeholder output. Large video processing is not handled in this repo.
- External social publishing is not implemented; treat the `publish` endpoint as a placeholder.
